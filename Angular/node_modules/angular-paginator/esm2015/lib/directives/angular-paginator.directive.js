import { Directive, Input, Output, EventEmitter } from '@angular/core';
import { AngularPaginatorService } from '../services/angular-paginator.service';
/**
 * This is the directive where the actual pagination takes place, it provides a sync between the
 * pipes and the pagination component
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../services/angular-paginator.service';
export class AngularPaginatorDirective {
    /**
     *
     * @param angularPaginatorService serivce for angular paginator
     */
    constructor(angularPaginatorService) {
        this.angularPaginatorService = angularPaginatorService;
        this.firstPage = 1;
        this.pages = [];
        /**
         * Emits an event whenever the current page is changed, It emits the current page number
         */
        this.pageChange = new EventEmitter(true);
        // subscribe to changes
        this.subscription = this.angularPaginatorService.change.subscribe((id) => {
            if (id === this.id) {
                this.updatePages();
            }
        });
    }
    /**
     * Navigate to prevoius page
     */
    toPreviousPage() {
        if (this.currentPage > this.firstPage) {
            this.setCurrentPage(this.currentPage - 1);
        }
        return;
    }
    /**
     * Navigate to next page
     */
    toNextPage() {
        if (this.currentPage < this.lastPage) {
            this.setCurrentPage(this.currentPage + 1);
        }
        return;
    }
    /**
     * Navigate to first page
     */
    toFirstPage() {
        this.setCurrentPage(this.firstPage);
        return;
    }
    /**
     * Navigate to last page
     */
    toLastPage() {
        this.setCurrentPage(this.lastPage);
        return;
    }
    /**
     * Sets current page
     *
     * @param page page number to set as currentPage
     */
    setCurrentPage(page) {
        if (page && this.currentPage !== page) {
            this.currentPage = page;
            this.pageChange.emit(page);
        }
        return;
    }
    /**
     * create page object used for template
     *
     * @param number page number
     * @param text page number, text to be displayed
     * @param isActive whether the page is active or not, true for currentPage
     */
    makePage(pageNumber, text, isActive) {
        return {
            number: pageNumber,
            text,
            active: isActive
        };
    }
    /**
     *  create page array
     *
     * @param currentPage current page number
     * @param itemsPerPage total items per page
     * @param totalItems no of items for pagination, usually array length
     */
    getPages(currentPage, itemsPerPage, totalItems) {
        const pages = [];
        // Default page limits
        const totalPages = this.lastPage = Math.ceil(totalItems / itemsPerPage);
        let startPage = 1;
        let endPage = totalPages;
        const isMaxSized = this.maxSize && this.maxSize < totalPages;
        // recompute if maxSize
        if (isMaxSized) {
            if (this.rotate) {
                // current page is displayed in the middle of the visible ones
                startPage = Math.max(currentPage - Math.floor(this.maxSize / 2), 1);
                endPage = startPage + this.maxSize - 1;
                // Adjust if limit is exceeded
                if (endPage > totalPages) {
                    endPage = totalPages;
                    startPage = endPage - this.maxSize + 1;
                }
            }
            else {
                // Visible pages are paginated with maxSize
                startPage = (Math.ceil(currentPage / this.maxSize) - 1) * this.maxSize + 1;
                // adjust last page if limit is exceeded
                endPage = Math.min(startPage + this.maxSize - 1, totalPages);
            }
        }
        // add page number links
        for (let pageNumber = startPage; pageNumber <= endPage; pageNumber++) {
            const page = this.makePage(pageNumber, pageNumber, pageNumber === currentPage);
            pages.push(page);
        }
        // add links to move between page sets
        if (isMaxSized && this.maxSize > 0 && (!this.rotate || this.forceEllipses || this.boundaryLinkNumbers)) {
            if (startPage > 1) {
                // need ellipsis for all options unless range is too close to beginning
                if (!this.boundaryLinkNumbers || startPage > 3) {
                    const previousPageSet = this.makePage(startPage - 1, '...', false);
                    pages.unshift(previousPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (startPage === 3) { // need to replace ellipsis when the buttons would be sequential
                        const secondPageLink = this.makePage(2, '2', false);
                        pages.unshift(secondPageLink);
                    }
                    // add the first page
                    const firstPageLink = this.makePage(1, '1', false);
                    pages.unshift(firstPageLink);
                }
            }
            if (endPage < totalPages) {
                // need ellipsis for all options unless range is too close to end
                if (!this.boundaryLinkNumbers || endPage < totalPages - 2) {
                    const nextPageSet = this.makePage(endPage + 1, '...', false);
                    pages.push(nextPageSet);
                }
                if (this.boundaryLinkNumbers) {
                    if (endPage === totalPages - 2) { // need to replace ellipsis when the buttons would be sequential
                        const secondToLastPageLink = this.makePage(totalPages - 1, totalPages - 1, false);
                        pages.push(secondToLastPageLink);
                    }
                    // add the last page
                    const lastPageLink = this.makePage(totalPages, totalPages, false);
                    pages.push(lastPageLink);
                }
            }
        }
        return pages;
    }
    /**
     * Updates the pagination component
     */
    updatePages() {
        const instance = this.angularPaginatorService.getInstance(this.id);
        const correctedCurrentPage = this.outOfBoundCorrection(instance);
        if (correctedCurrentPage !== instance.currentPage || this.currentPage !== instance.currentPage) {
            this.setCurrentPage(correctedCurrentPage);
        }
        this.pages = this.getPages(instance.currentPage, instance.itemsPerPage, instance.totalItems);
        return;
    }
    /**
     * Check if currentPage is out of bound with totalPages
     *
     * @param instance instance for which the range is to be corrected
     */
    outOfBoundCorrection(instance) {
        const totalPages = Math.ceil(instance.totalItems / instance.itemsPerPage);
        if (totalPages < instance.currentPage && 0 < totalPages) {
            return totalPages;
        }
        else if (instance.currentPage < 1) {
            return 1;
        }
        return instance.currentPage;
    }
    /**
     * check if there is any instance registered with the id
     */
    isValidId() {
        if (!this.angularPaginatorService.getInstance(this.id)) {
            throw new Error('There is no instance registered with id `' + this.id + '`');
        }
        return;
    }
    ngOnInit() {
        this.isValidId();
        this.updatePages();
    }
    ngOnDestroy() {
        /** destroy the subscription when the directive is destroyed */
        this.subscription.unsubscribe();
    }
}
AngularPaginatorDirective.ɵfac = function AngularPaginatorDirective_Factory(t) { return new (t || AngularPaginatorDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AngularPaginatorService)); };
AngularPaginatorDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: AngularPaginatorDirective, selectors: [["angularPaginator"], ["", "angularPaginator", ""]], inputs: { boundaryLinks: "boundaryLinks", directionLinks: "directionLinks", maxSize: "maxSize", rotate: "rotate", boundaryLinkNumbers: "boundaryLinkNumbers", forceEllipses: "forceEllipses", id: "id" }, outputs: { pageChange: "pageChange" }, exportAs: ["angularPaginator"] });
AngularPaginatorDirective.ctorParameters = () => [
    { type: AngularPaginatorService }
];
AngularPaginatorDirective.propDecorators = {
    boundaryLinks: [{ type: Input }],
    directionLinks: [{ type: Input }],
    maxSize: [{ type: Input }],
    rotate: [{ type: Input }],
    boundaryLinkNumbers: [{ type: Input }],
    forceEllipses: [{ type: Input }],
    id: [{ type: Input }],
    pageChange: [{ type: Output }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AngularPaginatorDirective, [{
        type: Directive,
        args: [{
                selector: 'angularPaginator, [angularPaginator]',
                exportAs: 'angularPaginator'
            }]
    }], function () { return [{ type: ɵngcc1.AngularPaginatorService }]; }, { pageChange: [{
            type: Output
        }], boundaryLinks: [{
            type: Input
        }], directionLinks: [{
            type: Input
        }], maxSize: [{
            type: Input
        }], rotate: [{
            type: Input
        }], boundaryLinkNumbers: [{
            type: Input
        }], forceEllipses: [{
            type: Input
        }], id: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5ndWxhci1wYWdpbmF0b3IuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2RpcmVjdGl2ZXMvYW5ndWxhci1wYWdpbmF0b3IuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQXFCLEtBQUssRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBSWhGO0FBQ0E7QUFDQTtBQUNBLEdBQUc7OztBQU1ILE1BQU0sT0FBTyx5QkFBeUI7QUFBRyxJQWdEdkM7QUFDRjtBQUNFO0FBQ0UsT0FBQztBQUNMLElBQUUsWUFBb0IsdUJBQWdEO0FBQ3RFLFFBRHNCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7QUFBQyxRQWZyRSxjQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQ2hCLFFBQ0UsVUFBSyxHQUFXLEVBQUUsQ0FBQztBQUNyQixRQUdFO0FBQ0Y7QUFFQSxXQURLO0FBQ0wsUUFBWSxlQUFVLEdBQXlCLElBQUksWUFBWSxDQUFTLElBQUksQ0FBQyxDQUFDO0FBQzlFLFFBT0ksdUJBQXVCO0FBQzNCLFFBQUksSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQVUsRUFBRSxFQUFFO0FBQ3JGLFlBQU0sSUFBSSxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBRTtBQUMxQixnQkFBUSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDM0IsYUFBTztBQUNQLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxJQUNFLENBQUM7QUFDSCxJQUNFO0FBQ0Y7QUFDRSxPQUFHO0FBQ0wsSUFBRSxjQUFjO0FBQUssUUFDakIsSUFBSSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDM0Ms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SztBQUFLLDZCQUlWLEtBQUs7QUFBSyxzQkFJVixLQUFLO0FBQUsscUJBSVYsS0FBSztBQUFLLGtDQVFWLEtBQUs7QUFBSyw0QkFJVixLQUFLO0FBQUssaUJBS1YsS0FBSztBQUFLLHlCQVlWLE1BQU07QUFBSTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPbkRlc3Ryb3ksIElucHV0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQW5ndWxhclBhZ2luYXRvclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9hbmd1bGFyLXBhZ2luYXRvci5zZXJ2aWNlJztcbmltcG9ydCB7IEFuZ3VsYXJQYWdpbmF0b3JJbnN0YW5jZSwgUGFnZSB9IGZyb20gJy4uL290aGVycy9hbmd1bGFyLXBhZ2luYXRvci5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbi8qKlxuICogVGhpcyBpcyB0aGUgZGlyZWN0aXZlIHdoZXJlIHRoZSBhY3R1YWwgcGFnaW5hdGlvbiB0YWtlcyBwbGFjZSwgaXQgcHJvdmlkZXMgYSBzeW5jIGJldHdlZW4gdGhlXG4gKiBwaXBlcyBhbmQgdGhlIHBhZ2luYXRpb24gY29tcG9uZW50XG4gKi9cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ2FuZ3VsYXJQYWdpbmF0b3IsIFthbmd1bGFyUGFnaW5hdG9yXScsXG4gIGV4cG9ydEFzOiAnYW5ndWxhclBhZ2luYXRvcidcbn0pXG5cbmV4cG9ydCBjbGFzcyBBbmd1bGFyUGFnaW5hdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGRpc3BsYXkgRmlyc3QgLyBMYXN0IGJ1dHRvbnNcbiAgICovXG4gIEBJbnB1dCgpIGJvdW5kYXJ5TGlua3M6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGRpc3BsYXkgUHJldmlvdXMgLyBOZXh0IGJ1dHRvbnNcbiAgICovXG4gIEBJbnB1dCgpIGRpcmVjdGlvbkxpbmtzOiBib29sZWFuO1xuICAvKipcbiAgICogTGltaXQgbnVtYmVyIGZvciBwYWdpbmF0aW9uIHNpemUsIGkuZS4sIHRoZSBtYXhpbXVtIHBhZ2UgbnVtYmVycyB0byBiZSBkaXNwbGF5ZWRcbiAgICovXG4gIEBJbnB1dCgpIG1heFNpemU6IG51bWJlcjtcbiAgLyoqXG4gICAqIFdoZXRoZXIgdG8ga2VlcCBjdXJyZW50IHBhZ2UgaW4gdGhlIG1pZGRsZSBvZiB0aGUgdmlzaWJsZSBvbmVzXG4gICAqL1xuICBASW5wdXQoKSByb3RhdGU6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGFsd2F5cyBkaXNwbGF5IHRoZSBmaXJzdCBhbmQgbGFzdCBwYWdlIG51bWJlcnMuXG4gICAqIElmIG1heC1zaXplIGlzIHNtYWxsZXIgdGhhbiB0aGUgbnVtYmVyIG9mIHBhZ2VzLCB0aGVuIHRoZSBmaXJzdCBhbmQgbGFzdCBwYWdlIG51bWJlcnMgYXJlIHN0aWxsIHNob3duIHdpdGggZWxsaXBzZXNcbiAgICogaW4tYmV0d2VlbiBhcyBuZWNlc3NhcnkuIE5PVEU6IG1heC1zaXplIHJlZmVycyB0byB0aGUgY2VudGVyIG9mIHRoZSByYW5nZS5cbiAgICogVGhpcyBvcHRpb24gbWF5IGFkZCB1cCB0byAyIG1vcmUgbnVtYmVycyBvbiBlYWNoIHNpZGUgb2YgdGhlIGRpc3BsYXllZCByYW5nZSBmb3IgdGhlIGVuZCB2YWx1ZSBhbmRcbiAgICogd2hhdCB3b3VsZCBiZSBhbiBlbGxpcHNpcyBidXQgaXMgcmVwbGFjZWQgYnkgYSBudW1iZXIgYmVjYXVzZSBpdCBpcyBzZXF1ZW50aWFsXG4gICAqL1xuICBASW5wdXQoKSBib3VuZGFyeUxpbmtOdW1iZXJzOiBib29sZWFuO1xuICAvKipcbiAgICogQWxzbyBkaXNwbGF5cyBlbGxpcHNlcyB3aGVuIHJvdGF0ZSBpcyB0cnVlIGFuZCBtYXhTaXplIGlzIHNtYWxsZXIgdGhhbiB0aGUgbnVtYmVyIG9mIHBhZ2VzIGZvcmNlRWxsaXBzZXNcbiAgICovXG4gIEBJbnB1dCgpIGZvcmNlRWxsaXBzZXM6IGJvb2xlYW47XG4gIC8qKlxuICAgKiBVc2UgdW5pcXVlIGlkIHdoZW4gbXVsdGlwbGUgcGFnaW5hdGlvbnMgYXJlIGJlaW5nIHVzZWQgb24gdGhlIHNhbWUgcGFnZS5cbiAgICogQnkgRGVmYXVsdCBQYWdpbmF0b3IgdXNlcyBpZCBgQU5HVUxBUl9QQUdJTkFUT1JfREVGQVVMVGBcbiAgICovXG4gIEBJbnB1dCgpIGlkOiBzdHJpbmc7XG5cbiAgY3VycmVudFBhZ2U6IG51bWJlcjtcbiAgZmlyc3RQYWdlID0gMTtcbiAgbGFzdFBhZ2U6IG51bWJlcjtcbiAgcGFnZXM6IFBhZ2VbXSA9IFtdO1xuXG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgLyoqXG4gICAqIEVtaXRzIGFuIGV2ZW50IHdoZW5ldmVyIHRoZSBjdXJyZW50IHBhZ2UgaXMgY2hhbmdlZCwgSXQgZW1pdHMgdGhlIGN1cnJlbnQgcGFnZSBudW1iZXJcbiAgICovXG4gIEBPdXRwdXQoKSBwYWdlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8bnVtYmVyPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVtYmVyPih0cnVlKTtcblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlIHNlcml2Y2UgZm9yIGFuZ3VsYXIgcGFnaW5hdG9yXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlOiBBbmd1bGFyUGFnaW5hdG9yU2VydmljZSkge1xuXG4gICAgLy8gc3Vic2NyaWJlIHRvIGNoYW5nZXNcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuYW5ndWxhclBhZ2luYXRvclNlcnZpY2UuY2hhbmdlLnN1YnNjcmliZSgoaWQ6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKGlkID09PSB0aGlzLmlkKSB7XG4gICAgICAgIHRoaXMudXBkYXRlUGFnZXMoKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICB9XG5cbiAgLyoqXG4gICAqIE5hdmlnYXRlIHRvIHByZXZvaXVzIHBhZ2VcbiAgICovXG4gIHRvUHJldmlvdXNQYWdlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlID4gdGhpcy5maXJzdFBhZ2UpIHtcbiAgICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UodGhpcy5jdXJyZW50UGFnZSAtIDEpO1xuICAgIH1cbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgdG8gbmV4dCBwYWdlXG4gICAqL1xuICB0b05leHRQYWdlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmN1cnJlbnRQYWdlIDwgdGhpcy5sYXN0UGFnZSkge1xuICAgICAgdGhpcy5zZXRDdXJyZW50UGFnZSh0aGlzLmN1cnJlbnRQYWdlICsgMSk7XG4gICAgfVxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBOYXZpZ2F0ZSB0byBmaXJzdCBwYWdlXG4gICAqL1xuICB0b0ZpcnN0UGFnZSgpOiB2b2lkIHtcbiAgICB0aGlzLnNldEN1cnJlbnRQYWdlKHRoaXMuZmlyc3RQYWdlKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvKipcbiAgICogTmF2aWdhdGUgdG8gbGFzdCBwYWdlXG4gICAqL1xuICB0b0xhc3RQYWdlKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0Q3VycmVudFBhZ2UodGhpcy5sYXN0UGFnZSk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgY3VycmVudCBwYWdlXG4gICAqXG4gICAqIEBwYXJhbSBwYWdlIHBhZ2UgbnVtYmVyIHRvIHNldCBhcyBjdXJyZW50UGFnZVxuICAgKi9cbiAgc2V0Q3VycmVudFBhZ2UocGFnZTogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHBhZ2UgJiYgdGhpcy5jdXJyZW50UGFnZSAhPT0gcGFnZSkge1xuICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IHBhZ2U7XG4gICAgICB0aGlzLnBhZ2VDaGFuZ2UuZW1pdChwYWdlKTtcbiAgICB9XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIGNyZWF0ZSBwYWdlIG9iamVjdCB1c2VkIGZvciB0ZW1wbGF0ZVxuICAgKlxuICAgKiBAcGFyYW0gbnVtYmVyIHBhZ2UgbnVtYmVyXG4gICAqIEBwYXJhbSB0ZXh0IHBhZ2UgbnVtYmVyLCB0ZXh0IHRvIGJlIGRpc3BsYXllZFxuICAgKiBAcGFyYW0gaXNBY3RpdmUgd2hldGhlciB0aGUgcGFnZSBpcyBhY3RpdmUgb3Igbm90LCB0cnVlIGZvciBjdXJyZW50UGFnZVxuICAgKi9cbiAgbWFrZVBhZ2UocGFnZU51bWJlcjogbnVtYmVyLCB0ZXh0OiBhbnksIGlzQWN0aXZlOiBib29sZWFuKTogYW55IHtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtYmVyOiBwYWdlTnVtYmVyLFxuICAgICAgdGV4dCxcbiAgICAgIGFjdGl2ZTogaXNBY3RpdmVcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqICBjcmVhdGUgcGFnZSBhcnJheVxuICAgKlxuICAgKiBAcGFyYW0gY3VycmVudFBhZ2UgY3VycmVudCBwYWdlIG51bWJlclxuICAgKiBAcGFyYW0gaXRlbXNQZXJQYWdlIHRvdGFsIGl0ZW1zIHBlciBwYWdlXG4gICAqIEBwYXJhbSB0b3RhbEl0ZW1zIG5vIG9mIGl0ZW1zIGZvciBwYWdpbmF0aW9uLCB1c3VhbGx5IGFycmF5IGxlbmd0aFxuICAgKi9cbiAgZ2V0UGFnZXMoY3VycmVudFBhZ2U6IG51bWJlciwgaXRlbXNQZXJQYWdlOiBudW1iZXIsIHRvdGFsSXRlbXM6IG51bWJlcik6IGFueSB7XG4gICAgY29uc3QgcGFnZXM6IGFueSA9IFtdO1xuXG4gICAgLy8gRGVmYXVsdCBwYWdlIGxpbWl0c1xuICAgIGNvbnN0IHRvdGFsUGFnZXM6IG51bWJlciA9IHRoaXMubGFzdFBhZ2UgPSBNYXRoLmNlaWwodG90YWxJdGVtcyAvIGl0ZW1zUGVyUGFnZSk7XG5cbiAgICBsZXQgc3RhcnRQYWdlID0gMTtcbiAgICBsZXQgZW5kUGFnZTogbnVtYmVyID0gdG90YWxQYWdlcztcbiAgICBjb25zdCBpc01heFNpemVkOiBib29sZWFuID0gdGhpcy5tYXhTaXplICYmIHRoaXMubWF4U2l6ZSA8IHRvdGFsUGFnZXM7XG5cbiAgICAvLyByZWNvbXB1dGUgaWYgbWF4U2l6ZVxuICAgIGlmIChpc01heFNpemVkKSB7XG5cbiAgICAgIGlmICh0aGlzLnJvdGF0ZSkge1xuXG4gICAgICAgIC8vIGN1cnJlbnQgcGFnZSBpcyBkaXNwbGF5ZWQgaW4gdGhlIG1pZGRsZSBvZiB0aGUgdmlzaWJsZSBvbmVzXG4gICAgICAgIHN0YXJ0UGFnZSA9IE1hdGgubWF4KGN1cnJlbnRQYWdlIC0gTWF0aC5mbG9vcih0aGlzLm1heFNpemUgLyAyKSwgMSk7XG4gICAgICAgIGVuZFBhZ2UgPSBzdGFydFBhZ2UgKyB0aGlzLm1heFNpemUgLSAxO1xuXG4gICAgICAgIC8vIEFkanVzdCBpZiBsaW1pdCBpcyBleGNlZWRlZFxuICAgICAgICBpZiAoZW5kUGFnZSA+IHRvdGFsUGFnZXMpIHtcbiAgICAgICAgICBlbmRQYWdlID0gdG90YWxQYWdlcztcbiAgICAgICAgICBzdGFydFBhZ2UgPSBlbmRQYWdlIC0gdGhpcy5tYXhTaXplICsgMTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gVmlzaWJsZSBwYWdlcyBhcmUgcGFnaW5hdGVkIHdpdGggbWF4U2l6ZVxuICAgICAgICBzdGFydFBhZ2UgPSAoTWF0aC5jZWlsKGN1cnJlbnRQYWdlIC8gdGhpcy5tYXhTaXplKSAtIDEpICogdGhpcy5tYXhTaXplICsgMTtcblxuICAgICAgICAvLyBhZGp1c3QgbGFzdCBwYWdlIGlmIGxpbWl0IGlzIGV4Y2VlZGVkXG4gICAgICAgIGVuZFBhZ2UgPSBNYXRoLm1pbihzdGFydFBhZ2UgKyB0aGlzLm1heFNpemUgLSAxLCB0b3RhbFBhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBhZGQgcGFnZSBudW1iZXIgbGlua3NcbiAgICBmb3IgKGxldCBwYWdlTnVtYmVyID0gc3RhcnRQYWdlOyBwYWdlTnVtYmVyIDw9IGVuZFBhZ2U7IHBhZ2VOdW1iZXIrKykge1xuICAgICAgY29uc3QgcGFnZSA9IHRoaXMubWFrZVBhZ2UocGFnZU51bWJlciwgcGFnZU51bWJlciwgcGFnZU51bWJlciA9PT0gY3VycmVudFBhZ2UpO1xuICAgICAgcGFnZXMucHVzaChwYWdlKTtcbiAgICB9XG5cbiAgICAvLyBhZGQgbGlua3MgdG8gbW92ZSBiZXR3ZWVuIHBhZ2Ugc2V0c1xuICAgIGlmIChpc01heFNpemVkICYmIHRoaXMubWF4U2l6ZSA+IDAgJiYgKCF0aGlzLnJvdGF0ZSB8fCB0aGlzLmZvcmNlRWxsaXBzZXMgfHwgdGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzKSkge1xuICAgICAgaWYgKHN0YXJ0UGFnZSA+IDEpIHtcblxuICAgICAgICAvLyBuZWVkIGVsbGlwc2lzIGZvciBhbGwgb3B0aW9ucyB1bmxlc3MgcmFuZ2UgaXMgdG9vIGNsb3NlIHRvIGJlZ2lubmluZ1xuICAgICAgICBpZiAoIXRoaXMuYm91bmRhcnlMaW5rTnVtYmVycyB8fCBzdGFydFBhZ2UgPiAzKSB7XG4gICAgICAgICAgY29uc3QgcHJldmlvdXNQYWdlU2V0ID0gdGhpcy5tYWtlUGFnZShzdGFydFBhZ2UgLSAxLCAnLi4uJywgZmFsc2UpO1xuICAgICAgICAgIHBhZ2VzLnVuc2hpZnQocHJldmlvdXNQYWdlU2V0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmJvdW5kYXJ5TGlua051bWJlcnMpIHtcblxuICAgICAgICAgIGlmIChzdGFydFBhZ2UgPT09IDMpIHsgLy8gbmVlZCB0byByZXBsYWNlIGVsbGlwc2lzIHdoZW4gdGhlIGJ1dHRvbnMgd291bGQgYmUgc2VxdWVudGlhbFxuICAgICAgICAgICAgY29uc3Qgc2Vjb25kUGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKDIsICcyJywgZmFsc2UpO1xuICAgICAgICAgICAgcGFnZXMudW5zaGlmdChzZWNvbmRQYWdlTGluayk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gYWRkIHRoZSBmaXJzdCBwYWdlXG4gICAgICAgICAgY29uc3QgZmlyc3RQYWdlTGluayA9IHRoaXMubWFrZVBhZ2UoMSwgJzEnLCBmYWxzZSk7XG4gICAgICAgICAgcGFnZXMudW5zaGlmdChmaXJzdFBhZ2VMaW5rKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZW5kUGFnZSA8IHRvdGFsUGFnZXMpIHtcblxuICAgICAgICAvLyBuZWVkIGVsbGlwc2lzIGZvciBhbGwgb3B0aW9ucyB1bmxlc3MgcmFuZ2UgaXMgdG9vIGNsb3NlIHRvIGVuZFxuICAgICAgICBpZiAoIXRoaXMuYm91bmRhcnlMaW5rTnVtYmVycyB8fCBlbmRQYWdlIDwgdG90YWxQYWdlcyAtIDIpIHtcbiAgICAgICAgICBjb25zdCBuZXh0UGFnZVNldCA9IHRoaXMubWFrZVBhZ2UoZW5kUGFnZSArIDEsICcuLi4nLCBmYWxzZSk7XG4gICAgICAgICAgcGFnZXMucHVzaChuZXh0UGFnZVNldCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5ib3VuZGFyeUxpbmtOdW1iZXJzKSB7XG5cbiAgICAgICAgICBpZiAoZW5kUGFnZSA9PT0gdG90YWxQYWdlcyAtIDIpIHsgLy8gbmVlZCB0byByZXBsYWNlIGVsbGlwc2lzIHdoZW4gdGhlIGJ1dHRvbnMgd291bGQgYmUgc2VxdWVudGlhbFxuICAgICAgICAgICAgY29uc3Qgc2Vjb25kVG9MYXN0UGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKHRvdGFsUGFnZXMgLSAxLCB0b3RhbFBhZ2VzIC0gMSwgZmFsc2UpO1xuICAgICAgICAgICAgcGFnZXMucHVzaChzZWNvbmRUb0xhc3RQYWdlTGluayk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gYWRkIHRoZSBsYXN0IHBhZ2VcbiAgICAgICAgICBjb25zdCBsYXN0UGFnZUxpbmsgPSB0aGlzLm1ha2VQYWdlKHRvdGFsUGFnZXMsIHRvdGFsUGFnZXMsIGZhbHNlKTtcbiAgICAgICAgICBwYWdlcy5wdXNoKGxhc3RQYWdlTGluayk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhZ2VzO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIHBhZ2luYXRpb24gY29tcG9uZW50XG4gICAqL1xuICB1cGRhdGVQYWdlcygpOiB2b2lkIHtcbiAgICBjb25zdCBpbnN0YW5jZTogQW5ndWxhclBhZ2luYXRvckluc3RhbmNlID0gdGhpcy5hbmd1bGFyUGFnaW5hdG9yU2VydmljZS5nZXRJbnN0YW5jZSh0aGlzLmlkKTtcblxuICAgIGNvbnN0IGNvcnJlY3RlZEN1cnJlbnRQYWdlID0gdGhpcy5vdXRPZkJvdW5kQ29ycmVjdGlvbihpbnN0YW5jZSk7XG5cbiAgICBpZiAoY29ycmVjdGVkQ3VycmVudFBhZ2UgIT09IGluc3RhbmNlLmN1cnJlbnRQYWdlIHx8IHRoaXMuY3VycmVudFBhZ2UgIT09IGluc3RhbmNlLmN1cnJlbnRQYWdlKSB7XG4gICAgICB0aGlzLnNldEN1cnJlbnRQYWdlKGNvcnJlY3RlZEN1cnJlbnRQYWdlKTtcbiAgICB9XG5cbiAgICB0aGlzLnBhZ2VzID0gdGhpcy5nZXRQYWdlcyhpbnN0YW5jZS5jdXJyZW50UGFnZSwgaW5zdGFuY2UuaXRlbXNQZXJQYWdlLCBpbnN0YW5jZS50b3RhbEl0ZW1zKTtcblxuICAgIHJldHVybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjdXJyZW50UGFnZSBpcyBvdXQgb2YgYm91bmQgd2l0aCB0b3RhbFBhZ2VzXG4gICAqXG4gICAqIEBwYXJhbSBpbnN0YW5jZSBpbnN0YW5jZSBmb3Igd2hpY2ggdGhlIHJhbmdlIGlzIHRvIGJlIGNvcnJlY3RlZFxuICAgKi9cbiAgb3V0T2ZCb3VuZENvcnJlY3Rpb24oaW5zdGFuY2U6IEFuZ3VsYXJQYWdpbmF0b3JJbnN0YW5jZSk6IG51bWJlciB7XG5cbiAgICBjb25zdCB0b3RhbFBhZ2VzID0gTWF0aC5jZWlsKGluc3RhbmNlLnRvdGFsSXRlbXMgLyBpbnN0YW5jZS5pdGVtc1BlclBhZ2UpO1xuXG4gICAgaWYgKHRvdGFsUGFnZXMgPCBpbnN0YW5jZS5jdXJyZW50UGFnZSAmJiAwIDwgdG90YWxQYWdlcykge1xuICAgICAgcmV0dXJuIHRvdGFsUGFnZXM7XG4gICAgfSBlbHNlIGlmIChpbnN0YW5jZS5jdXJyZW50UGFnZSA8IDEpIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cblxuICAgIHJldHVybiBpbnN0YW5jZS5jdXJyZW50UGFnZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBjaGVjayBpZiB0aGVyZSBpcyBhbnkgaW5zdGFuY2UgcmVnaXN0ZXJlZCB3aXRoIHRoZSBpZFxuICAgKi9cbiAgaXNWYWxpZElkKCk6IHZvaWQge1xuXG4gICAgaWYgKCF0aGlzLmFuZ3VsYXJQYWdpbmF0b3JTZXJ2aWNlLmdldEluc3RhbmNlKHRoaXMuaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZXJlIGlzIG5vIGluc3RhbmNlIHJlZ2lzdGVyZWQgd2l0aCBpZCBgJyArIHRoaXMuaWQgKyAnYCcpO1xuICAgIH1cblxuICAgIHJldHVybjtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaXNWYWxpZElkKCk7XG4gICAgdGhpcy51cGRhdGVQYWdlcygpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgLyoqIGRlc3Ryb3kgdGhlIHN1YnNjcmlwdGlvbiB3aGVuIHRoZSBkaXJlY3RpdmUgaXMgZGVzdHJveWVkICovXG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG59XG4iXX0=